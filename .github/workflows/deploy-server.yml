# 部署到自有服务器（通过 SSH）
name: Deploy to Server

on:
  push:
    branches: [main]
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 通过 SSH 部署到服务器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 60s
          debug: true
          script: |
            # 进入项目目录
            cd ${{ secrets.PROJECT_PATH }}
            
            # 拉取最新代码
            git pull origin main
            
            # 安装依赖
            pnpm install
            
            # 生成 Prisma Client
            pnpm prisma generate
            
            # 构建项目（包含数据库同步）
            pnpm build
            
            # 修改端口为 3000
            sed -i 's/start -p [0-9]*/start -p 3000/' ecosystem.config.js
            
            # 使用 PM2 ecosystem 配置文件实现零停机部署
            # 如果进程存在则 reload，否则启动
            if pm2 describe ink-and-code > /dev/null 2>&1; then
              # 进程已存在，使用 reload 实现优雅重启
              pm2 reload ecosystem.config.js --update-env
            else
              # 进程不存在，首次启动
              pm2 start ecosystem.config.js
            fi
            pm2 save
            
            echo "✅ 部署完成！"
