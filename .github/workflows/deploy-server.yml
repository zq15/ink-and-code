# 部署到自有服务器（GitHub 构建 + SSH 部署）
name: Deploy to Server

on:
  push:
    branches: [main]
  workflow_dispatch: # 允许手动触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install

      - name: 生成 Prisma Client
        run: pnpm prisma generate

      - name: 构建项目
        run: pnpm next build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: 打包部署文件
        run: |
          mkdir -p deploy
          cp -r .next deploy/.next
          cp -r public deploy/public
          cp -r prisma deploy/prisma
          cp -r content deploy/content
          cp package.json deploy/
          cp pnpm-lock.yaml deploy/
          cp ecosystem.config.js deploy/
          # 删除不需要的缓存
          rm -rf deploy/.next/cache
          # 打包
          tar -czf deploy.tar.gz -C deploy .

      - name: 上传部署包到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: 解压并重启服务
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 备份旧的 .env 文件（如果存在）
            if [ -f "${{ secrets.PROJECT_PATH }}/.env" ]; then
              cp ${{ secrets.PROJECT_PATH }}/.env /tmp/.env.backup
            fi
            
            # 清空目标目录
            rm -rf ${{ secrets.PROJECT_PATH }}/*
            rm -rf ${{ secrets.PROJECT_PATH }}/.[!.]*
            
            # 解压新文件
            tar -xzf /tmp/deploy.tar.gz -C ${{ secrets.PROJECT_PATH }}
            
            # 恢复 .env 文件
            if [ -f "/tmp/.env.backup" ]; then
              mv /tmp/.env.backup ${{ secrets.PROJECT_PATH }}/.env
            else
              # 创建 .env 文件
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > ${{ secrets.PROJECT_PATH }}/.env
            fi
            
            # 清理临时文件
            rm -f /tmp/deploy.tar.gz
            
            cd ${{ secrets.PROJECT_PATH }}
            
            # 安装生产依赖
            pnpm install --prod
            
            # 生成 Prisma Client
            pnpm prisma generate
            
            # 同步数据库
            pnpm prisma db push --skip-generate
            
            # 重启 PM2
            if pm2 describe ink-and-code > /dev/null 2>&1; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js
            fi
            pm2 save
            
            echo "✅ 部署完成！"
