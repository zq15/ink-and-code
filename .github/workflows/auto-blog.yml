name: Auto Blog from Commit

on:
  push:
    branches:
      - main
      - master

jobs:
  generate-blog:
    # Âè™Êúâ commit message ÂåÖÂê´ [blog] Êó∂ÊâçËøêË°å
    if: contains(github.event.head_commit.message, '[blog]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ëé∑ÂèñÊúÄËøë2Ê¨°Êèê‰∫§‰ª•‰æø diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get commit diff
        id: diff
        run: |
          # Ëé∑ÂèñÊú¨Ê¨° commit ÁöÑ diff
          DIFF=$(git diff HEAD~1 HEAD --no-color 2>/dev/null || git show HEAD --no-color)
          
          # Â∞Ü diff ‰øùÂ≠òÂà∞Êñá‰ª∂ÔºàÂ§ÑÁêÜÂ§öË°åÔºâ
          echo "$DIFF" > /tmp/commit_diff.txt
          
          # Ëé∑ÂèñÂèòÊõ¥ÁöÑÊñá‰ª∂ÂàóË°®
          FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --format="" HEAD)
          echo "files_changed<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate blog post with AI
        id: generate
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ËØªÂèñ diff
          DIFF=$(cat /tmp/commit_diff.txt)
          
          # ÂáÜÂ§á prompt
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          REPO="${{ github.repository }}"
          FILES_CHANGED="${{ steps.diff.outputs.files_changed }}"
          
          # ÂàõÂª∫ AI ËØ∑Ê±ÇÁöÑ prompt (‰ΩøÁî® heredoc)
          PROMPT=$(cat <<'PROMPT_EOF'
          You are a technical blog writer. Based on the following Git commit information, write a technical blog post in Chinese.

          Commit Info:
          PROMPT_EOF
          )
          PROMPT="$PROMPT
          - Repository: ${REPO}
          - Commit Message: ${COMMIT_MSG}
          - Changed Files:
          ${FILES_CHANGED}

          Commit Diff:
          ${DIFF:0:10000}

          Requirements:
          1. Create an attractive title highlighting technical aspects
          2. Write in Markdown format
          3. Include: background, solution details, key code explanation, summary
          4. Use proper language tags for code blocks
          5. Keep it 800-1500 words
          6. Write in Chinese

          Output format:
          ---TITLE---
          <article title>
          ---CONTENT---
          <article content in Markdown>
          ---TAGS---
          <tag1>,<tag2>,<tag3>"

          # ‰ΩøÁî® DeepSeekÔºà‰ºòÂÖàÔºâ„ÄÅClaude Êàñ OpenAI API
          # ËΩ¨‰πâ JSON ÁâπÊÆäÂ≠óÁ¨¶
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          if [ -n "$DEEPSEEK_API_KEY" ]; then
            echo "Using DeepSeek API..."
            
            RESPONSE=$(curl -s https://api.deepseek.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
              -d "{
                \"model\": \"deepseek-chat\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $ESCAPED_PROMPT
                }]
              }")
            
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
            
          elif [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Using Claude API..."
            
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{
                \"model\": \"claude-sonnet-4-20250514\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $ESCAPED_PROMPT
                }]
              }")
            
            # ÊèêÂèñÁîüÊàêÁöÑÂÜÖÂÆπ
            GENERATED=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
            
          elif [ -n "$OPENAI_API_KEY" ]; then
            echo "Using OpenAI API..."
            
            RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"gpt-4o\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $ESCAPED_PROMPT
                }]
              }")
            
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          else
            echo "Error: No AI API key provided (need DEEPSEEK_API_KEY, ANTHROPIC_API_KEY, or OPENAI_API_KEY)"
            exit 1
          fi
          
          if [ -z "$GENERATED" ]; then
            echo "Error: AI generation failed"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          # ‰øùÂ≠òÁîüÊàêÁöÑÂÜÖÂÆπ
          echo "$GENERATED" > /tmp/generated_post.txt
          
          # Ëß£ÊûêÊ†áÈ¢ò„ÄÅÂÜÖÂÆπ„ÄÅÊ†áÁ≠æ
          TITLE=$(echo "$GENERATED" | sed -n '/---TITLE---/,/---CONTENT---/p' | head -n -1 | tail -n +2 | tr -d '\n')
          CONTENT=$(echo "$GENERATED" | sed -n '/---CONTENT---/,/---TAGS---/p' | head -n -1 | tail -n +2)
          TAGS=$(echo "$GENERATED" | sed -n '/---TAGS---/,$p' | tail -n +2 | tr -d '\n')
          
          # ËæìÂá∫Âà∞ GitHub Actions ÂèòÈáè
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          
          # Â§öË°åÂÜÖÂÆπÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
          {
            echo 'content<<CONTENT_EOF'
            echo "$CONTENT"
            echo 'CONTENT_EOF'
          } >> $GITHUB_OUTPUT
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Publish to blog
        env:
          INK_AND_CODE_TOKEN: ${{ secrets.INK_AND_CODE_TOKEN }}
          INK_AND_CODE_URL: ${{ secrets.INK_AND_CODE_URL }}
        run: |
          TITLE="${{ steps.generate.outputs.title }}"
          CONTENT="${{ steps.generate.outputs.content }}"
          TAGS="${{ steps.generate.outputs.tags }}"
          
          # Â∞Ü tags ËΩ¨‰∏∫ JSON Êï∞ÁªÑ
          TAGS_JSON=$(echo "$TAGS" | tr ',' '\n' | jq -R . | jq -s .)
          
          # ËΩ¨‰πâÂÜÖÂÆπ
          ESCAPED_CONTENT=$(echo "$CONTENT" | jq -Rs .)
          ESCAPED_TITLE=$(echo "$TITLE" | jq -Rs . | sed 's/^"//;s/"$//')
          
          # ÂèëÈÄÅÂà∞ÂçöÂÆ¢ API
          RESPONSE=$(curl -s -X POST "${INK_AND_CODE_URL}/api/article/create-from-commit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $INK_AND_CODE_TOKEN" \
            -d "{
              \"title\": \"$ESCAPED_TITLE\",
              \"content\": $ESCAPED_CONTENT,
              \"tags\": $TAGS_JSON,
              \"published\": false,
              \"commitInfo\": {
                \"repo\": \"${{ github.repository }}\",
                \"sha\": \"${{ github.sha }}\",
                \"message\": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
                \"url\": \"${{ github.event.head_commit.url }}\"
              }
            }")
          
          echo "API Response: $RESPONSE"
          
          # Ê£ÄÊü•ÂìçÂ∫î
          CODE=$(echo "$RESPONSE" | jq -r '.code // 500')
          if [ "$CODE" != "201" ]; then
            echo "Failed to publish blog post"
            echo "Error: $(echo "$RESPONSE" | jq -r '.message // "Unknown error"')"
            exit 1
          fi
          
          ARTICLE_URL=$(echo "$RESPONSE" | jq -r '.data.url // "N/A"')
          echo "‚úÖ Blog post created successfully!"
          echo "üìù Title: $TITLE"
          echo "üîó URL: $ARTICLE_URL"
