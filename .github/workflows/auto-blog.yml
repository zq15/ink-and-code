# Auto generate blog posts from commits with TipTap format
# Fixed broken pipe error by using head directly instead of cat|head
name: Auto Blog from Commit

on:
  push:
    branches:
      - main
      - master

jobs:
  generate-blog:
    if: contains(github.event.head_commit.message, '[blog]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Gather project context
        run: |
          echo "=== Gathering project context ==="
          
          # 1. Git diff
          git diff HEAD~1 HEAD --no-color > /tmp/commit_diff.txt 2>/dev/null || git show HEAD --no-color > /tmp/commit_diff.txt
          git diff --name-only HEAD~1 HEAD > /tmp/files_changed.txt 2>/dev/null || git show --name-only --format="" HEAD > /tmp/files_changed.txt
          
          # 2. Project structure (exclude node_modules, .git, etc.)
          echo "Project Structure:" > /tmp/project_structure.txt
          find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" \) \
            ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/dist/*" ! -path "*/.next/*" ! -path "*/pnpm-lock.yaml" \
            | head -200 >> /tmp/project_structure.txt
          
          # 3. Read changed files content (limit each file to 500 lines)
          echo "" > /tmp/changed_files_content.txt
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              echo "=== File: $file ===" >> /tmp/changed_files_content.txt
              head -500 "$file" >> /tmp/changed_files_content.txt
              echo "" >> /tmp/changed_files_content.txt
            fi
          done < /tmp/files_changed.txt
          
          # 4. Read key config files
          echo "" > /tmp/key_configs.txt
          for config in "package.json" "README.md" "prisma/schema.prisma"; do
            if [[ -f "$config" ]]; then
              echo "=== $config ===" >> /tmp/key_configs.txt
              head -100 "$config" >> /tmp/key_configs.txt
              echo "" >> /tmp/key_configs.txt
            fi
          done
          
          # 5. Read SKILL.md if exists
          if [[ -f "skills/auto-blog-from-commit/SKILL.md" ]]; then
            cat "skills/auto-blog-from-commit/SKILL.md" > /tmp/skill_guide.txt
          else
            echo "No SKILL.md found" > /tmp/skill_guide.txt
          fi
          
          echo "Context gathered successfully"

      - name: Generate and publish blog post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INK_AND_CODE_TOKEN: ${{ secrets.INK_AND_CODE_TOKEN }}
          INK_AND_CODE_URL: ${{ secrets.INK_AND_CODE_URL }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          REPO_NAME: ${{ github.repository }}
        shell: bash
        run: |
          # Load context files (with size limits)
          # Use head directly instead of cat|head to avoid broken pipe errors
          DIFF=$(head -c 6000 /tmp/commit_diff.txt 2>/dev/null || true)
          FILES=$(cat /tmp/files_changed.txt 2>/dev/null || true)
          PROJECT_STRUCTURE=$(head -c 3000 /tmp/project_structure.txt 2>/dev/null || true)
          CHANGED_FILES_CONTENT=$(head -c 15000 /tmp/changed_files_content.txt 2>/dev/null || true)
          KEY_CONFIGS=$(head -c 3000 /tmp/key_configs.txt 2>/dev/null || true)
          SKILL_GUIDE=$(head -c 2000 /tmp/skill_guide.txt 2>/dev/null || true)
          
          # Build comprehensive prompt
          printf '%s\n' "You are a senior technical blog writer with deep understanding of software development." > /tmp/prompt.txt
          printf '%s\n' "Write a high-quality Chinese technical blog post based on the following project context." >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== PROJECT INFO ===" >> /tmp/prompt.txt
          printf '%s\n' "Repository - ${REPO_NAME}" >> /tmp/prompt.txt
          printf '%s\n' "Commit - ${COMMIT_MSG}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== PROJECT STRUCTURE ===" >> /tmp/prompt.txt
          printf '%s\n' "${PROJECT_STRUCTURE}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== KEY CONFIGS ===" >> /tmp/prompt.txt
          printf '%s\n' "${KEY_CONFIGS}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== CHANGED FILES ===" >> /tmp/prompt.txt
          printf '%s\n' "${FILES}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== CHANGED FILES CONTENT ===" >> /tmp/prompt.txt
          printf '%s\n' "${CHANGED_FILES_CONTENT}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== GIT DIFF ===" >> /tmp/prompt.txt
          printf '%s\n' "${DIFF}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== WRITING GUIDE ===" >> /tmp/prompt.txt
          printf '%s\n' "${SKILL_GUIDE}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== REQUIREMENTS ===" >> /tmp/prompt.txt
          printf '%s\n' "1. Write an attractive Chinese title (no quotes)" >> /tmp/prompt.txt
          printf '%s\n' "2. Markdown format, use ## headings, NO leading spaces" >> /tmp/prompt.txt
          printf '%s\n' "3. Explain WHY this change was made, not just WHAT changed" >> /tmp/prompt.txt
          printf '%s\n' "4. Include code snippets with explanations" >> /tmp/prompt.txt
          printf '%s\n' "5. 1000-2000 words in Chinese" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "=== OUTPUT FORMAT (use EXACT markers) ===" >> /tmp/prompt.txt
          printf '%s\n' "TITLE_START" >> /tmp/prompt.txt
          printf '%s\n' "中文标题" >> /tmp/prompt.txt
          printf '%s\n' "TITLE_END" >> /tmp/prompt.txt
          printf '%s\n' "CONTENT_START" >> /tmp/prompt.txt
          printf '%s\n' "## 背景" >> /tmp/prompt.txt
          printf '%s\n' "为什么做这个改动..." >> /tmp/prompt.txt
          printf '%s\n' "## 技术实现" >> /tmp/prompt.txt
          printf '%s\n' "核心代码解析..." >> /tmp/prompt.txt
          printf '%s\n' "## 关键代码" >> /tmp/prompt.txt
          printf '%s\n' "代码片段和解释..." >> /tmp/prompt.txt
          printf '%s\n' "## 总结" >> /tmp/prompt.txt
          printf '%s\n' "收获和思考..." >> /tmp/prompt.txt
          printf '%s\n' "CONTENT_END" >> /tmp/prompt.txt
          printf '%s\n' "TAGS_START" >> /tmp/prompt.txt
          printf '%s\n' "标签1,标签2,标签3" >> /tmp/prompt.txt
          printf '%s\n' "TAGS_END" >> /tmp/prompt.txt
          
          PROMPT=$(cat /tmp/prompt.txt)
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          if [ -n "$DEEPSEEK_API_KEY" ]; then
            echo "Using DeepSeek API..."
            RESPONSE=$(curl -s https://api.deepseek.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
              -d "{\"model\":\"deepseek-chat\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":$ESCAPED_PROMPT}]}")
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          elif [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Using Claude API..."
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{\"model\":\"claude-sonnet-4-20250514\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":$ESCAPED_PROMPT}]}")
            GENERATED=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          elif [ -n "$OPENAI_API_KEY" ]; then
            echo "Using OpenAI API..."
            RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{\"model\":\"gpt-4o\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":$ESCAPED_PROMPT}]}")
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          else
            echo "Error - No AI API key provided"
            exit 1
          fi
          
          if [ -z "$GENERATED" ]; then
            echo "Error - AI generation failed"
            echo "Response - $RESPONSE"
            exit 1
          fi
          
          echo "AI Response received, parsing..."
          echo "$GENERATED" > /tmp/ai_output.txt
          
          echo "=== Raw AI Output (first 2000 chars) ==="
          head -c 2000 /tmp/ai_output.txt
          echo ""
          echo "=== End of preview ==="
          
          awk '/TITLE_START/{flag=1; next} /TITLE_END/{flag=0} flag' /tmp/ai_output.txt | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > /tmp/title.txt
          awk '/CONTENT_START/{flag=1; next} /CONTENT_END/{flag=0} flag' /tmp/ai_output.txt > /tmp/content.txt  
          awk '/TAGS_START/{flag=1; next} /TAGS_END/{flag=0} flag' /tmp/ai_output.txt | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > /tmp/tags.txt
          
          TITLE=$(cat /tmp/title.txt)
          TAGS=$(cat /tmp/tags.txt)
          CONTENT_LINES=$(wc -l < /tmp/content.txt)
          CONTENT_SIZE=$(wc -c < /tmp/content.txt)
          
          echo "=== Parsed Results ==="
          echo "Title - $TITLE"
          echo "Tags - $TAGS"
          echo "Content lines - $CONTENT_LINES"
          echo "Content size - $CONTENT_SIZE bytes"
          echo "=== Content Preview (first 500 chars) ==="
          head -c 500 /tmp/content.txt
          echo ""
          echo "=== End content preview ==="
          
          if [ -z "$TITLE" ] || [ ! -s /tmp/content.txt ]; then
            echo "Error - Failed to parse AI output"
            echo "Raw output -"
            cat /tmp/ai_output.txt
            exit 1
          fi
          
          jq -n \
            --arg title "$TITLE" \
            --rawfile content /tmp/content.txt \
            --arg tags "$TAGS" \
            --arg repo "$REPO_NAME" \
            --arg sha "$COMMIT_SHA" \
            --arg msg "$COMMIT_MSG" \
            --arg url "$COMMIT_URL" \
            '{
              title: $title,
              content: $content,
              tags: ($tags | split(",") | map(gsub("^\\s+|\\s+$"; ""))),
              published: false,
              commitInfo: {
                repo: $repo,
                sha: $sha,
                message: $msg,
                url: $url
              }
            }' > /tmp/payload.json
          
          echo "=== Payload Preview ==="
          cat /tmp/payload.json | head -c 1000
          echo ""
          echo "========================"
          
          echo "Publishing to ${INK_AND_CODE_URL}/api/article/create-from-commit ..."
          RESULT=$(curl -sL -w "\n%{http_code}" -X POST "${INK_AND_CODE_URL}/api/article/create-from-commit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $INK_AND_CODE_TOKEN" \
            -d @/tmp/payload.json)
          
          HTTP_CODE=$(echo "$RESULT" | tail -n1)
          BODY=$(echo "$RESULT" | sed '$d')
          
          echo "HTTP Status - $HTTP_CODE"
          echo "API Response - $BODY"
          
          if ! echo "$BODY" | jq -e . > /dev/null 2>&1; then
            echo "Error - API returned invalid JSON"
            echo "Raw response -"
            echo "$BODY"
            exit 1
          fi
          
          CODE=$(echo "$BODY" | jq -r '.code // 500')
          if [ "$CODE" != "201" ]; then
            echo "Failed to publish"
            echo "Error - $(echo "$BODY" | jq -r '.message // "Unknown error"')"
            exit 1
          fi
          
          ARTICLE_URL=$(echo "$BODY" | jq -r '.data.url // "N/A"')
          echo ""
          echo "=========================================="
          echo "Blog post created successfully!"
          echo "Title - $TITLE"
          echo "URL - $ARTICLE_URL"
          echo "=========================================="
