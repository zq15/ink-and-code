name: Auto Blog from Commit

on:
  push:
    branches:
      - main
      - master

jobs:
  generate-blog:
    if: contains(github.event.head_commit.message, '[blog]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit diff
        run: |
          git diff HEAD~1 HEAD --no-color > /tmp/commit_diff.txt 2>/dev/null || git show HEAD --no-color > /tmp/commit_diff.txt
          git diff --name-only HEAD~1 HEAD > /tmp/files_changed.txt 2>/dev/null || git show --name-only --format="" HEAD > /tmp/files_changed.txt

      - name: Generate and publish blog post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INK_AND_CODE_TOKEN: ${{ secrets.INK_AND_CODE_TOKEN }}
          INK_AND_CODE_URL: ${{ secrets.INK_AND_CODE_URL }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          REPO_NAME: ${{ github.repository }}
        shell: bash
        run: |
          DIFF=$(cat /tmp/commit_diff.txt | head -c 8000)
          FILES=$(cat /tmp/files_changed.txt)
          
          printf '%s\n' "You are a technical blog writer. Write a Chinese blog post about this commit." > /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "Repository - ${REPO_NAME}" >> /tmp/prompt.txt
          printf '%s\n' "Commit - ${COMMIT_MSG}" >> /tmp/prompt.txt
          printf '%s\n' "Files - ${FILES}" >> /tmp/prompt.txt
          printf '%s\n' "Diff - ${DIFF}" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "Requirements -" >> /tmp/prompt.txt
          printf '%s\n' "1. Chinese title without quotes" >> /tmp/prompt.txt
          printf '%s\n' "2. Markdown format, start with ## headings, NO leading spaces, NO blockquotes" >> /tmp/prompt.txt
          printf '%s\n' "3. Include background, implementation, summary sections" >> /tmp/prompt.txt
          printf '%s\n' "4. 800-1500 words in Chinese" >> /tmp/prompt.txt
          printf '%s\n' "" >> /tmp/prompt.txt
          printf '%s\n' "Output format (use these EXACT markers) -" >> /tmp/prompt.txt
          printf '%s\n' "TITLE_START" >> /tmp/prompt.txt
          printf '%s\n' "中文标题" >> /tmp/prompt.txt
          printf '%s\n' "TITLE_END" >> /tmp/prompt.txt
          printf '%s\n' "CONTENT_START" >> /tmp/prompt.txt
          printf '%s\n' "## 背景" >> /tmp/prompt.txt
          printf '%s\n' "内容..." >> /tmp/prompt.txt
          printf '%s\n' "## 实现" >> /tmp/prompt.txt
          printf '%s\n' "内容..." >> /tmp/prompt.txt
          printf '%s\n' "## 总结" >> /tmp/prompt.txt
          printf '%s\n' "内容..." >> /tmp/prompt.txt
          printf '%s\n' "CONTENT_END" >> /tmp/prompt.txt
          printf '%s\n' "TAGS_START" >> /tmp/prompt.txt
          printf '%s\n' "标签1,标签2" >> /tmp/prompt.txt
          printf '%s\n' "TAGS_END" >> /tmp/prompt.txt
          
          PROMPT=$(cat /tmp/prompt.txt)
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          if [ -n "$DEEPSEEK_API_KEY" ]; then
            echo "Using DeepSeek API..."
            RESPONSE=$(curl -s https://api.deepseek.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
              -d "{\"model\":\"deepseek-chat\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":$ESCAPED_PROMPT}]}")
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          elif [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Using Claude API..."
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{\"model\":\"claude-sonnet-4-20250514\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":$ESCAPED_PROMPT}]}")
            GENERATED=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          elif [ -n "$OPENAI_API_KEY" ]; then
            echo "Using OpenAI API..."
            RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{\"model\":\"gpt-4o\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":$ESCAPED_PROMPT}]}")
            GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          else
            echo "Error - No AI API key provided"
            exit 1
          fi
          
          if [ -z "$GENERATED" ]; then
            echo "Error - AI generation failed"
            echo "Response - $RESPONSE"
            exit 1
          fi
          
          echo "AI Response received, parsing..."
          echo "$GENERATED" > /tmp/ai_output.txt
          
          echo "=== Raw AI Output (first 2000 chars) ==="
          head -c 2000 /tmp/ai_output.txt
          echo ""
          echo "=== End of preview ==="
          
          awk '/TITLE_START/{flag=1; next} /TITLE_END/{flag=0} flag' /tmp/ai_output.txt | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > /tmp/title.txt
          awk '/CONTENT_START/{flag=1; next} /CONTENT_END/{flag=0} flag' /tmp/ai_output.txt > /tmp/content.txt  
          awk '/TAGS_START/{flag=1; next} /TAGS_END/{flag=0} flag' /tmp/ai_output.txt | tr -d '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > /tmp/tags.txt
          
          TITLE=$(cat /tmp/title.txt)
          TAGS=$(cat /tmp/tags.txt)
          CONTENT_LINES=$(wc -l < /tmp/content.txt)
          CONTENT_SIZE=$(wc -c < /tmp/content.txt)
          
          echo "=== Parsed Results ==="
          echo "Title - $TITLE"
          echo "Tags - $TAGS"
          echo "Content lines - $CONTENT_LINES"
          echo "Content size - $CONTENT_SIZE bytes"
          echo "=== Content Preview (first 500 chars) ==="
          head -c 500 /tmp/content.txt
          echo ""
          echo "=== End content preview ==="
          
          if [ -z "$TITLE" ] || [ ! -s /tmp/content.txt ]; then
            echo "Error - Failed to parse AI output"
            echo "Raw output -"
            cat /tmp/ai_output.txt
            exit 1
          fi
          
          jq -n \
            --arg title "$TITLE" \
            --rawfile content /tmp/content.txt \
            --arg tags "$TAGS" \
            --arg repo "$REPO_NAME" \
            --arg sha "$COMMIT_SHA" \
            --arg msg "$COMMIT_MSG" \
            --arg url "$COMMIT_URL" \
            '{
              title: $title,
              content: $content,
              tags: ($tags | split(",") | map(gsub("^\\s+|\\s+$"; ""))),
              published: false,
              commitInfo: {
                repo: $repo,
                sha: $sha,
                message: $msg,
                url: $url
              }
            }' > /tmp/payload.json
          
          echo "=== Payload Preview ==="
          cat /tmp/payload.json | head -c 1000
          echo ""
          echo "========================"
          
          echo "Publishing to ${INK_AND_CODE_URL}/api/article/create-from-commit ..."
          RESULT=$(curl -sL -w "\n%{http_code}" -X POST "${INK_AND_CODE_URL}/api/article/create-from-commit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $INK_AND_CODE_TOKEN" \
            -d @/tmp/payload.json)
          
          HTTP_CODE=$(echo "$RESULT" | tail -n1)
          BODY=$(echo "$RESULT" | sed '$d')
          
          echo "HTTP Status - $HTTP_CODE"
          echo "API Response - $BODY"
          
          if ! echo "$BODY" | jq -e . > /dev/null 2>&1; then
            echo "Error - API returned invalid JSON"
            echo "Raw response -"
            echo "$BODY"
            exit 1
          fi
          
          CODE=$(echo "$BODY" | jq -r '.code // 500')
          if [ "$CODE" != "201" ]; then
            echo "Failed to publish"
            echo "Error - $(echo "$BODY" | jq -r '.message // "Unknown error"')"
            exit 1
          fi
          
          ARTICLE_URL=$(echo "$BODY" | jq -r '.data.url // "N/A"')
          echo ""
          echo "=========================================="
          echo "Blog post created successfully!"
          echo "Title - $TITLE"
          echo "URL - $ARTICLE_URL"
          echo "=========================================="
